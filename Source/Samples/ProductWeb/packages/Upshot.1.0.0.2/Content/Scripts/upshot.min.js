(function(n,t){function f(n,t){for(var i in t)n[i]=t[i];return n}function a(t){for(var f=t.split("."),u=n,r,i=0;i<f.length;i++)r=u[f[i]],r&&typeof r=="object"||(u[f[i]]=r={}),u=r;return u}function d(n,t,i){return n=n||function(){},t&&f(n.prototype,t),i&&f(n,i),n}function y(n,t,i){var r={};return f(r,n),f(r,i),t=t||function(){},t.prototype=r,t.prototype.constructor=t,t}function u(n){return n===null?"null":n===t?"undefined":Object.prototype.toString.call(n).slice(8,-1).toLowerCase()}function o(n){return u(n)==="array"}function l(n){return u(n)==="object"}function et(n){return o(n)&&(n.length===0||!(o(n[0])||l(n[0])))}function nt(n){return u(n)==="date"}function tt(n){return u(n)==="function"}function it(n){return typeof n=="string"&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(n)}function s(n){if(n===null||n===t)return!0;for(var i in n)if(g.call(n,i))return!1;return!0}function h(n){return n||(n=""),n+rt++}function ot(n,r,u){var f;if(!n)return;if(arguments.length===2)return f=i.cacheName,f&&n[f]?n[f][r]:null;if(n.nodeType!==t)throw"upshot.cache cannot be used with DOM elements";return f=i.cacheName||(i.cacheName=h("__upshot__")),n[f]||(n[f]=function(){}),n[f][r]=u}function ut(n,t){var r=i.cacheName;r&&n&&n[r]&&(t&&delete n[r][t],(!t||s(n[r]))&&delete n[r])}function ft(n,t){if(n.length!==t.length)return!1;for(var i=0;i<n.length;i++)if(n[i]!==t[i])return!1;return!0}function p(n,r){for(var f=i.isFunction(r)?r:t,u=0;u<n.length;u++)if(f?f(n[u]):n[u]===r)return n.splice(u,1),u;return-1}function v(n){r.push(n)}function k(n){r.splice($.inArray(n,r),1)}function c(){if(e)throw"Cannot make observable edits from within an event callback.";try{e=!0;var n=r.slice();$.each(n,function(n,t){t.__recomputeDependentViews()}),$.each(n,function(n,t){t.__flushEntityStateChangedEvents&&t.__flushEntityStateChangedEvents()})}finally{e=!1}}function w(){if(e)throw"Cannot make observable edits from within an event callback.";}function b(){c()}var g=Object.prototype.hasOwnProperty,rt=0,i=a("upshot"),r,e;i.extend=f,i.defineNamespace=a,i.defineClass=d,i.deriveClass=y,i.classof=u,i.isArray=o,i.isObject=l,i.isValueArray=et,i.isDate=nt,i.isFunction=tt,i.isGuid=it,i.isEmpty=s,i.uniqueId=h,i.cacheName=null,i.cache=ot,i.deleteCache=ut,i.sameArrayContents=ft,i.arrayRemove=p,i.EntityState={Unmodified:"Unmodified",ClientUpdated:"ClientUpdated",ClientAdded:"ClientAdded",ClientDeleted:"ClientDeleted",ServerUpdating:"ServerUpdating",ServerAdding:"ServerAdding",ServerDeleting:"ServerDeleting",Deleted:"Deleted",isClientModified:function(n){return n&&n.indexOf("Client")===0},isServerSyncing:function(n){return n&&n.indexOf("Server")===0},isUpdated:function(n){return n&&n.indexOf("Updat")>0},isDeleted:function(n){return n&&n.indexOf("Delet")>0},isAdded:function(n){return n&&n.indexOf("Add")>0}},r=[],i.__registerRootEntitySource=v,i.__deregisterRootEntitySource=k,i.__triggerRecompute=c,i.__beginChange=w,i.__endChange=b})(this),(function(n,t,i){var u=i.observability=i.observability||{};t.each(["track","insert","remove","refresh","isProperty","getProperty","setProperty","isArray","createCollection","asArray","map","unmap","setContextProperty"],function(n,t){u[t]=function(){var n=u.configuration;return n[t].apply(n,arguments)}}),i.map=function(n,t,i){return u.configuration.map(n,t,null,i)}})(this,jQuery,upshot),(function(n,t,i){var e=i.observability,f={},u;i.metadata=function(n){if(arguments.length===0)return t.extend({},f);if(typeof n=="string"){if(arguments.length===1)return f[n];f[n]||(f[n]=arguments[1])}else t.each(n,function(n,t){i.metadata(n,t)})},i.metadata.getProperties=function(n,t,r){var o=[],s,f,u;if(t){s=i.metadata(t);if(s&&s.fields){f=s.fields;for(u in f)(r||!f[u].association)&&o.push({name:u,type:f[u].type,association:f[u].association});return o}}for(u in n)n.hasOwnProperty(u)&&e.isProperty(n,u)&&u.indexOf("jQuery")!==0&&o.push({name:u});return o},i.metadata.getPropertyType=function(n,t){if(n){var r=i.metadata(n);if(r&&r.fields&&r.fields[t])return r.fields[t].type}return null},i.metadata.isEntityType=function(n){if(n){var t=i.metadata(n);if(t&&t.key)return!0}return!1},u={},i.registerType=function(n,r){if(i.isObject(n))t.each(n,function(n,t){i.registerType(n,t)});else{var f=u[n]||(u[n]=[]);t.inArray(r,f)<0&&f.push(r)}return i},i.type=function(n){var f,i,r,t;for(i in u)if(u.hasOwnProperty(i))for(r=u[i],t=0;t<r.length;t++)if(r[t]()===n)return i;throw"No type string registered for key '"+n+"'.";}})(this,jQuery,upshot),(function(n,t,i){var u=i.observability,o=function(n){var t=n&&n.result,r;if(t)if(i.EntitySource.as(t))throw"Array is already bound to an EntitySource.";this._viewsToRecompute=[],this._eventCallbacks={},this._clientEntities=t||u.createCollection(),this._bindFromOptions(n,["arrayChanged","propertyChanged","entityStateChanged"]),r=this,u.track(this._clientEntities,{afterChange:function(n,t,u){i.__beginChange(),r._handleArrayChange(t,u)},afterEvent:function(){i.__endChange()}}),i.cache(this._clientEntities,"entitySource",this)},e={dispose:function(){this._eventCallbacks&&(u.track(this._clientEntities,null),i.deleteCache(this._clientEntities,"entitySource"),this._dispose(),this._eventCallbacks=null)},bind:function(n,t){var r,i;if(typeof n=="string")r=this._eventCallbacks[n]||(this._eventCallbacks[n]=[]),r.push(t);else for(i in n)this.bind(i,n[i]);return this},unbind:function(n,t){var r,i,f,u;if(typeof n=="string"){r=this._eventCallbacks&&this._eventCallbacks[n];if(r)for(i=0,f=r.length;i<f;i++)if(r[i]===t){r.splice(i,1);break}}else for(u in n)this.unbind(u,n[u]);return this},getEntities:function(){return this._clientEntities},__registerForRecompute:function(n){t.inArray(n,this._viewsToRecompute)>0||this._viewsToRecompute.push(n)},__recomputeDependentViews:function(){while(this._viewsToRecompute.length>0){var n=this._viewsToRecompute.slice();this._viewsToRecompute.splice(0,this._viewsToRecompute.length),t.each(n,function(n,t){t.__recompute()})}},__addEntity:function(n){var t=u.asArray(this._clientEntities).length;u.insert(this._clientEntities,t,[n]),this._handleArrayChange("insert",{index:t,items:[n]})},__deleteEntity:function(n,i){var i=t.inArray(n,u.asArray(this._clientEntities));u.remove(this._clientEntities,i,1),this._handleArrayChange("remove",{index:i,items:[n]})},_bindFromOptions:function(n,i){if(n){var r=this;t.each(i,function(t,i){var u=n&&n[i];u&&r.bind(i,u)})}},_dispose:function(){},_handleArrayChange:function(n,t){var r,f;switch(n){case"insert":r=t.items;if(r.length>1)throw"NYI -- Can only add a single entity to/from an array in one operation.";f=r[0],this._handleEntityAdd(f);break;case"remove":throw"Use 'deleteEntity' to delete entities from your array.  Destructive delete is not yet implemented.";case"replaceAll":if(!i.sameArrayContents(t.newItems,u.asArray(this._clientEntities)))throw"NYI -- Can only replaceAll with own entities.";break;default:throw"NYI -- Array operation '"+n+"' is not supported.";}this._trigger("arrayChanged",n,t)},_handleEntityAdd:function(){},_purgeEntity:function(n){var i=t.inArray(n,u.asArray(this._clientEntities));u.remove(this._clientEntities,i,1),this._trigger("arrayChanged","remove",{index:i,items:[n]})},_trigger:function(n){var t=this._eventCallbacks[n],u,i,r;if(t)for(u=Array.prototype.slice.call(arguments,1),t=t.slice(0),i=0,r=t.length;i<r;i++)t[i].apply(this,u);return this}},f={as:function(n){return i.cache(n,"entitySource")}};i.EntitySource=i.defineClass(o,e,f)})(this,jQuery,upshot),(function(n,t,i){var u=i.EntitySource.prototype,o=i.observability,s=function(n){var t,i;this._needRecompute=!1,t=this,this._observer={propertyChanged:function(n,i,r){t._onPropertyChanged(n,i,r)},arrayChanged:function(n,i){t._onArrayChanged(n,i)},entityStateChanged:function(n,i,r){t._onEntityStateChanged(n,i,r)},entityUpdated:function(n,i,r){t._onEntityUpdated(n,i,r)}},this._entitySource=null,i=n&&n.source,i&&this._bindToEntitySource(i),u.constructor.call(this,n)},f=["getDataContext","getEntityState","getEntityValidationRules","getEntityId","revertChanges","deleteEntity","getEntityErrors","getEntityError","isUpdated","revertUpdates"],e={__registerForRecompute:function(){u.__registerForRecompute.apply(this,arguments),this._entitySource.__registerForRecompute(this)},__recompute:function(){this._needRecompute&&(this._needRecompute=!1,this._recompute()),this.__recomputeDependentViews()},_dispose:function(){this._entitySource&&this._entitySource.unbind(this._observer),u._dispose.apply(this,arguments)},_bindToEntitySource:function(n){if(this._entitySource===n)return;var i=this;this._entitySource&&(t.each(f,function(n,t){i[t]&&delete i[t]}),this._entitySource.unbind(this._observer)),this._entitySource=n,n.getDataContext&&t.each(f,function(t,r){r!=="getEntityErrors"&&(i[r]=function(){var t=n[r].apply(n,arguments);return r==="deleteEntity"?i:t})}),this.getEntityErrors=function(){return t.grep(n.getEntityErrors(),function(n){return i._haveEntity(n.entity)})},n.bind(this._observer)},_setNeedRecompute:function(){this._needRecompute=!0,this._entitySource.__registerForRecompute(this)},_recompute:function(){throw"Unreachable";},_handleEntityAdd:function(n){this._entitySource.__addEntity(n),u._handleEntityAdd.apply(this,arguments)},_haveEntity:function(n){return t.inArray(n,o.asArray(this._clientEntities))>=0},_purgeEntity:function(){u._purgeEntity.apply(this,arguments)},_onPropertyChanged:function(n,t,i){this._haveEntity(n)&&this._trigger("propertyChanged",n,t,i)},_onArrayChanged:function(){},_onEntityStateChanged:function(n,t,r){this._haveEntity(n)&&(t===i.EntityState.Deleted&&this._purgeEntity(n),this._trigger("entityStateChanged",n,t,r))},_onEntityUpdated:function(n,t,i){this._haveEntity(n)&&this._trigger("entityUpdated",n,t,i)}};i.EntityView=i.deriveClass(u,s,e),i.EntityView.__dataContextMethodNames=f})(this,jQuery,upshot),(function(n,t,i){var e=i.EntityView.prototype,u=i.observability,f={paging:"setPaging",sort:"setSort",filter:"setFilter"},s=function(n){if(n&&n.result&&n.result.length!==0)throw'NYI -- Currently, "result" array must be empty to bind to a data source.';this._skip=null,this._take=null,this._includeTotalCount=!1,this._lastRefreshTotalEntityCount=0,this._allowRefreshWithEdits=n&&!!n.allowRefreshWithEdits;if(n){var i=this;t.each(n,function(n,t){f[n]&&i[f[n]](t)})}e.constructor.apply(this,arguments),this._bindFromOptions(n,["refreshStart","refreshSuccess","refreshError"])},o={setSort:function(){throw"Unreachable";},setFilter:function(){throw"Unreachable";},setPaging:function(n){return n=n||{},this._skip=n.skip,this._take=n.take,this._includeTotalCount=!!n.includeTotalCount,this},getTotalEntityCount:function(){return this._lastRefreshTotalEntityCount},refresh:function(){throw"Unreachable";},reset:function(){return this._applyNewQueryResult([]),this},_normalizeFilters:function(n){var f,u,r;for(n=i.isArray(n)?n:[n],f=[],u=0;u<n.length;u++)r=n[u],r&&(t.isFunction(r)||(r.operator=r.operator||"=="),f.push(r));return f},_verifyOkToRefresh:function(){if(!this._allowRefreshWithEdits){var n=this;t.each(u.asArray(this._clientEntities),function(t,r){if(n.getEntityState(r)!==i.EntityState.Unmodified)throw"Refreshing this DataSource will potentially remove unsaved entities.  Such entities might encounter errors during save, and your app should have UI to view such errors.  Either disallow DataSource.refresh() with edits or build error UI and suppress this exception with the 'allowRefreshWithEdits' DataSource option.";})}},_completeRefresh:function(n,r,f){this._applyNewQueryResult(n,r)&&i.__triggerRecompute();var o=u.asArray(this._clientEntities),e=this._lastRefreshTotalEntityCount;this._trigger("refreshSuccess",o,e),t.isFunction(f)&&f.call(this,o,e)},_failRefresh:function(n,i,r,u){this._trigger("refreshError",n,i,r),t.isFunction(u)&&u.call(this,n,i,r)},_applyNewQueryResult:function(n,t){var f,r;return this._lastRefreshTotalEntityCount=t,f=i.sameArrayContents(u.asArray(this._clientEntities),n),f?!1:(r=u.asArray(this._clientEntities).slice(),u.refresh(this._clientEntities,n),this._trigger("arrayChanged","replaceAll",{oldItems:r,newItems:u.asArray(this._clientEntities)}),!0)}};i.DataSource=i.deriveClass(e,s,o)})(this,jQuery,upshot),(function(n,t,i){var f=i.EntitySource.prototype,u=i.observability,e=function(n,t){var f=function(n,t){if(t.length===0)return[n];var r=f(i.isArray(n)?n[t.shift()]:u.getProperty(n,t.shift()),t);return r.unshift(n),r},r=t.replace(/\]|\(|\)/g,"").replace(/\[/g,".").split(".");return{tokens:r,objs:f(n,r.slice())}},h=function(n,t){this._dataContext=n,this._entityType=t,this._callbacks={},this._serverEntities=[],this._entityStates={},this._addedEntities=[],this._errors=[],this._associatedEntitiesViews={},this._tracked={},this._tracker=null,this._deferredEntityStateChangeEvents=[],f.constructor.call(this),i.__registerRootEntitySource(this)},s={dispose:function(){throw"EntitySets should only be disposed by their DataContext.";},getEntityState:function(n){var t=this.getEntityId(n);return t===null?null:this._entityStates[t]},getEntityId:function(n){var t=this._getAddedEntityFromEntity(n);if(t)return t.clientId;try{return this._getEntityIdentity(this._getChanges(n)?this._getOriginalValue(n,this._entityType):n)}catch(i){return null}},getDataContext:function(){return this._dataContext},getEntityValidationRules:function(){var n=i.metadata(this._entityType);return n&&n.rules&&{rules:n.rules,messages:n.messages}},getEntityErrors:function(){var n=this;return t.map(this._errors,function(t){var i=n._tracked[t];return{entity:i.obj,error:i.error}})},getEntityError:function(n){var t=this._getTrackingId(n);if(t)return this._tracked[t].error},revertUpdates:function(n,t,r){var o=this.getEntityId(n),u=o!==null&&this._entityStates[o],f,s;if(u&&u!==i.EntityState.Deleted)if(i.EntityState.isServerSyncing(u))throw"Can't revert an entity while changes are being committed.";else return u!==i.EntityState.ClientUpdated?this:t?(f=e(n,t),s=this._clearChangesOnPath(f.objs.slice(),f.tokens.slice(),r),!this.isUpdated(n)&&this._updateEntityState(o,i.EntityState.Unmodified),this._restoreOriginalValues(n,this._entityType,s),this._triggerEntityUpdated(n),i.__triggerRecompute(),this):this.revertChanges(n);else throw"Entity not cached in data context.";},revertChanges:function(n){if(n){i.isArray(n)||(n=[n]);var r=this;t.each(n,function(n,t){var f=r.getEntityId(t),u=f!==null&&r._entityStates[f],e;if(u&&u!==i.EntityState.Deleted)if(i.EntityState.isServerSyncing(u))throw"Can't revert an entity while changes are being committed.";else{if(u===i.EntityState.Unmodified)return;if(u===i.EntityState.ClientDeleted||u===i.EntityState.ClientUpdated)r._updateEntityState(f,i.EntityState.Unmodified),e=r._clearChanges(t,!0),r._restoreOriginalValues(t,r._entityType,e),r._triggerEntityUpdated(t);else if(u===i.EntityState.ClientAdded)r._purgeUncommittedAddedEntity(r._getAddedEntityFromId(f),!0);else throw"Entity changes cannot be reverted for entity in state '"+u+"'.";}else throw"Entity no longer cached in data context.";})}else this.__revertChanges();return i.__triggerRecompute(),this},isUpdated:function(n,t,r){var c=this.getEntityId(n),h=c!==null&&this._entityStates[c],f,o,l,u,s;if(!h||!i.EntityState.isUpdated(h))return!1;return f=n,t&&(u=e(n,t),f=u.objs[u.objs.length-2],l=u.objs[u.objs.length-1],i.isArray(f)||(o=u.tokens[u.tokens.length-1])),s=this._getChanges(f),s?t?(o?s.original.hasOwnProperty(o):!1)||(r?!1:this._getChanges(l)!==null):!0:!1},deleteEntity:function(n){var t=this.getEntityId(n),r=t!==null&&this._entityStates[t];if(r)if(r===i.EntityState.ClientAdded)this._purgeUncommittedAddedEntity(this._getAddedEntityFromId(t));else if(i.EntityState.isServerSyncing(r))throw"Can't delete an entity while previous changes are being committed.";else this._updateEntityState(t,i.EntityState.ClientDeleted),this._dataContext.__queueImplicitCommit();else throw"Entity not cached in data context.";return i.__triggerRecompute(),this},__dispose:function(){var n=this;t.each(this._tracked,function(t,i){n._deleteTracking(i.obj)}),i.__deregisterRootEntitySource(this),f.dispose.call(this)},__loadEntities:function(n){var e=this,i=[],r=this._serverEntities.length,f=t.map(n,function(n){return e._loadEntity(n,i)});return i.length>0&&(u.insert(this._clientEntities,r,i),this._trigger("arrayChanged","insert",{index:r,items:i})),f},__getEditedEntities:function(){var r=this,n=[];return t.each(this._entityStates,function(t,u){i.EntityState.isClientModified(u)&&n.push(r._getEntityFromId(t))}),n},__getEntityEdit:function(n){var f=this.getEntityId(n),u=this,o,r,e=function(n){return t.extend({__type:u._entityType},n)},s,h;switch(this._entityStates[f]){case i.EntityState.ClientUpdated:o=i.EntityState.ServerUpdating,r={Operation:3,Entity:e(this._getSerializableEntity(n)),OriginalEntity:e(this._getOriginalValue(n,this._entityType))};break;case i.EntityState.ClientAdded:o=i.EntityState.ServerAdding,n=this._getAddedEntityFromId(f).entity,r={Operation:2,Entity:e(this._getSerializableEntity(n))};break;case i.EntityState.ClientDeleted:o=i.EntityState.ServerDeleting,r={Operation:4,Entity:e(this._getOriginalValue(n,this._entityType))};break;default:throw"Unrecognized entity state.";}return s=u.getEntityError(n),h={entityType:this._entityType,storeEntity:n,operation:r,updateEntityState:function(){u._updateEntityState(f,o,s)},succeeded:function(n){u._handleSubmitSucceeded(f,r,n)},failed:function(n){u._handleSubmitFailed(f,r,n||s)}},h},__revertChanges:function(){var u,n,r;t.each(this._entityStates,function(n,t){if(i.EntityState.isServerSyncing(t))return u=!0,!1});if(u)throw"Can't revert changes to all entities while previous changes are being committed.  Try 'revertChanges(entity)' for entities not presently being committed.";n=[];for(r in this._entityStates)i.EntityState.isClientModified(this._entityStates[r])&&n.push(this._getEntityFromId(r));n.length>0&&this.revertChanges(n)},__flushEntityStateChangedEvents:function(){var n=this;t.each(this._deferredEntityStateChangeEvents,function(t,i){n._trigger.apply(n,["entityStateChanged"].concat(i))}),this._deferredEntityStateChangeEvents.splice(0,this._deferredEntityStateChangeEvents.length)},__setProperty:function(n,t,r){var f={oldValues:{},newValues:{}};f.oldValues[t]=u.getProperty(n,t),f.newValues[t]=r,this._copyOnWrite(n,f),this._removeTracking(this._getOldFromEvent("change",f)),u.setProperty(n,t,r),this._addTracking([r],i.metadata.getPropertyType(this._entityType,t),n,t),this._bubbleChange(n,null,"",f)},_loadEntity:function(n,t){var u=this._getEntityIdentity(n),f=this._getEntityIndexFromIdentity(u),r;return f<0?(r=u,this._addTracking([n],this._entityType),this._entityStates[r]=i.EntityState.Unmodified,this._serverEntities.push({entity:n,identity:r}),this._updateEntityState(r,i.EntityState.Unmodified,null,n),this._addAssociationProperties(n),t.push(n)):n=this._merge(this._serverEntities[f].entity,n),n},_handleEntityAdd:function(n){if(this._getEntityIndex(n)>=0||this._getAddedEntityFromEntity(n))throw"Entity already in data source.";var t=i.uniqueId("added");addedEntity={entity:n,clientId:t},this._addedEntities.push(addedEntity),this._addTracking([n],this._entityType),this._entityStates[t]=i.EntityState.Unmodified,this._updateEntityState(t,i.EntityState.ClientAdded),this._addAssociationProperties(n),this._dataContext.__queueImplicitCommit(),f._handleEntityAdd.apply(this,arguments)},_changeEntityStateForUpdate:function(n){var r=this.getEntityId(n),t=r!==null&&this._entityStates[r];if(t){if(t!==i.EntityState.ClientAdded)if(i.EntityState.isServerSyncing(t))throw"Can't update an entity while previous changes are being committed.";else this._updateEntityState(r,i.EntityState.ClientUpdated,this.getEntityError(n))}else throw"Entity not cached in data context.";this._dataContext.__queueImplicitCommit()},_updateEntityState:function(n,t,i,r){var f,e;r=r||this._getEntityFromId(n),f=this._entityStates[n],this._entityStates[n]&&(this._entityStates[n]=t,f!==t&&u.setContextProperty(r,"entity","state",t)),e=this._updateEntityError(r,i),(f!==t||e)&&this._deferredEntityStateChangeEvents.push([r,t,i])},_updateEntityError:function(n,i){var e=this._getTrackingId(n),f=this._tracked[e],r,o=t.inArray(e,this._errors);return o>-1?i?i!==f.error&&(f.error=i,r=!0):(this._errors.splice(o,1),delete f.error,r=!0):i&&(this._errors.push(e),f.error=i,r=!0),r&&u.setContextProperty(n,"entity","error",i),r},_purgeUncommittedAddedEntity:function(n){this._purgeEntityInternal(n.entity,n.clientId)},_purgeServerEntity:function(n,t){this._serverEntities.splice(this._getEntityIndex(n),1),this._purgeEntityInternal(n,t)},_purgeEntityInternal:function(n,t){var u=this._entityStates[t],r;for(this._updateEntityState(t,i.EntityState.Deleted,null,n),this._clearChanges(n),this._removeTracking([n]),r=0;r<this._addedEntities.length;r++)if(this._addedEntities[r].clientId===t){this._addedEntities.splice(r,1);break}delete this._entityStates[t],this._disposeAssociationEntitiesViews(t),this._purgeEntity(n)},_getEntityIdentity:function(n){return i.EntitySet.__getIdentity(n,this._entityType)},_getEntityIndexFromIdentity:function(n){for(var i=-1,t=0;t<this._serverEntities.length;t++)if(this._serverEntities[t].identity===n){i=t;break}return i},_getEntityIndex:function(n){for(var i=-1,t=0;t<this._serverEntities.length;t++)if(this._serverEntities[t].entity===n){i=t;break}return i},_addTracking:function(n,i,r,u){var f=this;t.each(n,function(n,t){f._addTrackingRecursive(r,u,t,i)})},_addTrackingRecursive:function(n,r,f,e){var o,h,s;if(i.isArray(f)||i.isObject(f)){o=this._getTracking(f);if(o){if(o.active)throw"Value is already tracked";}else h=i.cache(f,"trackingId",i.uniqueId("tracking")),o=this._tracked[h]={};o.obj=f,o.type=e,o.parentId=this._getTrackingId(n)||null,o.property=i.isArray(n)?null:r,o.active=!0,o.changes=o.changes||null,u.track(f,this._getTracker(),this._entityType),i.isArray(f)?i.isValueArray(f)||(s=this,t.each(f,function(n,t){s._addTrackingRecursive(f,n,t,e)})):(s=this,t.each(i.metadata.getProperties(f,e),function(n,t){s._addTrackingRecursive(f,t.name,u.getProperty(f,t.name),t.type)}))}},_getTracker:function(){if(this._tracker===null){var n=this;this._tracker={beforeChange:function(t,i,r){n._isAssociationPropertySet(t,i,r)||(n._copyOnWrite(t,r),n._removeTracking(n._getOldFromEvent(i,r)))},afterChange:function(r,u,f){i.__beginChange();if(!n._handleAssociationPropertySet(r,u,f)){var e=n._getTracking(r);u==="change"?t.each(f.newValues,function(t,u){n._addTracking([u],i.metadata.getPropertyType(e.type,t),r,t)}):n._addTracking(n._getNewFromEvent(u,f),e.type,r),n._bubbleChange(r,null,[],f)}},afterEvent:function(){i.__endChange()}},this._dataContext.__manageAssociations&&(this._tracker.includeAssociations=!0)}return this._tracker},_isAssociationPropertySet:function(n,t,r){var f,u,e;if(t==="change"&&this._dataContext.__manageAssociations&&this._getTracking(n).parentId===null){f=(i.metadata(this._entityType)||{}).fields;if(f)for(u in f){e=f[u];if(e.association&&(u in r.oldValues||u in r.newValues)){if(this._getOldFromEvent(t,r).length>1||this._getNewFromEvent(t,r).length>1)throw"NYI -- Can't include association properties in N>1 property sets.";return!0}}}return!1},_handleAssociationPropertySet:function(n,t,i){var f,r,u,o,e;if(!this._isAssociationPropertySet(n,t,i))return!1;f=this.getEntityId(n);if(f===null||!(f in this._entityStates))throw"Entity not cached in data context.";for(u in i.oldValues){r=u;break}if(!r)for(u in i.newValues){r=u;break}return o=this._associatedEntitiesViews[f],e=o[r],e.__handleParentPropertySet(i.newValues[r]),!0},_removeTracking:function(n){var i=this;t.each(n,function(n,t){i._removeTrackingRecursive(t)})},_removeTrackingRecursive:function(n){var f,r;(i.isArray(n)||i.isObject(n))&&(f=this._getTracking(n),f&&(f.changes===null?this._deleteTracking(n):f.active=!1,u.track(n,null),i.isArray(n)?i.isValueArray(n)||(r=this,t.each(n,function(n,t){r._removeTrackingRecursive(t)})):(r=this,t.each(n,function(t){r._removeTrackingRecursive(u.getProperty(n,t))}))))},_deleteTracking:function(n){var t=this._getTrackingId(n);i.deleteCache(n,"trackingId"),delete this._tracked[t]},_getOldFromEvent:function(n,i){if(n==="change"){var r=[];return t.each(i.oldValues,function(n,t){r.push(t)}),r}return n==="remove"?i.items:n==="replaceAll"?i.oldItems:[]},_getNewFromEvent:function(n,i){if(n==="change"){var r=[];return t.each(i.newValues,function(n,t){r.push(t)}),r}return n==="insert"?i.items:n==="replaceAll"?i.newItems:[]},_getTrackingId:function(n){return i.cache(n,"trackingId")},_getTracking:function(n){var t=this._getTrackingId(n);return t?this._tracked[t]:null},_getChanges:function(n){var t=this._getTracking(n);return t?this._getTracking(n).changes:null},_bubbleChange:function(n,i,r,u){var f=this._getTracking(n),e;i&&this._recordChangedChild(n,i),f.parentId===null?(r.length>1&&(r=r.slice(1)),this._handlePropertyChange(n,u,i===null),this._triggerEntityUpdated(n,r,u)):(e=this._tracked[f.parentId].obj,r=(f.property?"."+f.property:"["+t.inArray(n,e)+"]")+r,this._bubbleChange(e,n,r,u))},_copyOnWrite:function(n,t){i.isArray(n)?this._recordWriteToArray(n):this._recordWriteToObject(n,t.oldValues)},_recordWriteToArray:function(n){var i=this._getTracking(n),t=i.changes||(i.changes={original:null,children:{}});t.original||(t.original=n.slice(0))},_recordWriteToObject:function(n,i){var f=this._getTracking(n),r=f.changes||(f.changes={original:{},children:{}});t.each(i,function(t,i){r.original.hasOwnProperty(t)||(r.original[t]=i),u.setContextProperty(n,"property",t,!0)})},_recordChangedChild:function(n,t){i.isArray(n)?this._recordChangedChildOfArray(n,t):this._recordChangedChildOfObject(n,t)},_recordChangedChildOfArray:function(n,t){var r=this._getTracking(n),u=r.changes||(r.changes={original:null,children:{}}),i=this._getTrackingId(t);u.children[i]=i},_recordChangedChildOfObject:function(n,t){var r=this._getTracking(n),u=r.changes||(r.changes={original:{},children:{}}),i=this._getTrackingId(t);u.children[i]=i},_clearChanges:function(n,r){var s=this._getTracking(n),f=s.changes,e={original:{},children:{}},o;return f&&(i.isArray(n)?e.original=f.original:t.each(f.original,function(t,i){e.original[t]=i,delete f.original[t],u.setContextProperty(n,"property",t,!1)}),o=this,t.each(f.children,function(n,t){var i=o._tracked[t];e.children[t]=o._clearChanges(i.obj,r)}),s.changes=null,r||s.active||this._deleteTracking(n)),e},_clearChangesOnPath:function(n,r,f){var v=n.shift(),s=r.shift(),a=this._getTracking(v),e=a.changes,c={original:{},children:{}},h,l,o;return e&&(r.length===0?(h=[n[0]],e.original.hasOwnProperty(s)&&(h.push(e.original[s]),c.original[s]=h[1],delete e.original[s],u.setContextProperty(v,"property",s,!1)),f||(l=this,t.each(h,function(n,t){var i=l._getTrackingId(t);i&&e.children.hasOwnProperty(i)&&(c.children[i]=l._clearChanges(t,!0),delete e.children[i])}))):(o=this._getTrackingId(n[0]),o&&e.children.hasOwnProperty(o)&&(c.children[o]=this._clearChangesOnPath(n,r,f),this._tracked[o].changes===null&&delete e.children[o])),i.isEmpty(e.original)&&i.isEmpty(e.children)&&(a.changes=null)),c},_getOriginalValue:function(n,r,f){if(i.isArray(n)&&f)throw"property is not a supported parameter when getting original array values";var s=this,o=this._getChanges(n),e;return f?o&&o.original.hasOwnProperty(f)?o.original[f]:u.getProperty(n,f):i.isArray(n)?(e=(o?o.original||n:n).slice(0),t.each(e,function(n,t){e[n]=s._getOriginalValue(t,r)}),e):i.isObject(n)?(e={},t.each(i.metadata.getProperties(n,r),function(t,i){var u=s._getOriginalValue(n,r,i.name);e[i.name]=s._getOriginalValue(u,i.type)}),e):n},_restoreOriginalValues:function(n,r,u){if(u){var f=this;i.isArray(n)?u.original!==null&&f._arrayRefresh(n,r,u.original):t.each(u.original,function(t,u){f._setProperty(n,i.metadata.getPropertyType(r,t),t,u)}),t.each(u.children,function(n,t){var i=f._tracked[n];f._restoreOriginalValues(i.obj,i.type,t)})}},_merge:function(n,t){return this.isUpdated(n)||this._mergeObject(n,t,this._entityType),n},_mergeObject:function(n,r,f){var e=this;t.each(i.metadata.getProperties(r,f,!1),function(t,o){var s=u.getProperty(n,o.name),h=u.getProperty(r,o.name);if(s!==h){if(i.classof(s)===i.classof(h)){if(i.isArray(s)){i.isValueArray(s)||e._mergeArray(s,h,o.type);return}if(i.isObject(s)){e._mergeObject(s,h,o.type);return}}e._setProperty(n,f,o.name,h)}})},_mergeArray:function(n,i,r){var u=this;t.each(i,function(t,i){var f=n[t];f&&u._mergeObject(f,i,r)}),n.length>i.length?this._arrayRemove(n,r,i.length,n.length-i.length):n.length<i.length&&this._arrayInsert(n,r,n.length,i.slice(n.length))},_handlePropertyChange:function(n,t,i){var u,f,r;for(r in t.newValues)if(t.newValues.hasOwnProperty(r)){if(u)throw"NYI -- Can only update one property at a time.";u=r,f=t.newValues[r]}if(u==="")return;i&&this._trigger("propertyChanged",n,u,f),this._changeEntityStateForUpdate(n)},_setProperty:function(n,t,r,f){var e=this._getTracking(n).parentId;this._removeTracking([u.getProperty(n,r)]),u.setProperty(n,r,f),this._addTracking([f],i.metadata.getPropertyType(t,r),n,r),e===null&&this._trigger("propertyChanged",n,r,f)},_arrayRefresh:function(n,t,i){this._removeTracking(n),u.refresh(n,i),this._addTracking(n,t,n)},_arrayRemove:function(n,t,i,r){this._removeTracking(n.slice(i,r)),u.remove(n,i,r)},_arrayInsert:function(n,t,i,r){u.insert(n,i,r),this._addTracking(r,t,n)},_triggerEntityUpdated:function(n,t,i){(this.isUpdated(n)||!i)&&this._trigger("entityUpdated",n,t,i)},_getAddedEntityFromId:function(n){var i=t.grep(this._addedEntities,function(t){return t.clientId===n});return i[0]},_getAddedEntityFromEntity:function(n){var i=t.grep(this._addedEntities,function(t){return t.entity===n});return i[0]},_handleSubmitSucceeded:function(n,t,r){var u=this._getEntityFromId(n);switch(t.Operation){case 2:this._updateEntityState(n,i.EntityState.Unmodified),this._getAddedEntityFromId(n).committed=!0,this._serverEntities.push({entity:u,identity:this._getEntityIdentity(r.Entity)}),this._clearChanges(u,!1),this._merge(u,r.Entity);break;case 3:this._updateEntityState(n,i.EntityState.Unmodified),this._clearChanges(u,!1),this._merge(u,r.Entity),this._triggerEntityUpdated(u);break;case 4:this._purgeServerEntity(u,n)}},_handleSubmitFailed:function(n,t,r){var f=this._getEntityFromId(n),u;switch(t.Operation){case 2:u=i.EntityState.ClientAdded;break;case 3:u=i.EntityState.ClientUpdated;break;case 4:u=i.EntityState.ClientDeleted}this._updateEntityState(n,u,r)},_getEntityFromId:function(n){var i=this._getAddedEntityFromId(n),t;if(i)return i.entity;for(t=0;t<this._serverEntities.length;t++)if(this._serverEntities[t].identity===n)return this._serverEntities[t].entity},_addAssociationProperties:function(n){var r;if(!this._dataContext.__manageAssociations)return;r=(i.metadata(this._entityType)||{}).fields;if(r){var e=this.getEntityId(n),u=this._associatedEntitiesViews[e]={},f=this;t.each(r,function(t,i){if(i.association){if(u[t])throw"Duplicate property metadata for property '"+t+"'.";u[t]=f._createAssociatedEntitiesView(n,t,i)}})}},_createAssociatedEntitiesView:function(n,t,r){if(!r.association.isForeignKey&&!r.array)throw"NYI: Singleton child entities are not currently supported";var o=this._dataContext.getEntitySet(r.type),e=r.association.isForeignKey,s=e?function(){var r=u.getProperty(n,t),i=u.asArray(this.getEntities())[0]||null;r!==i&&(u.setProperty(n,t,i),this._trigger("propertyChanged",n,t,i))}:null,c=e?o:this,h=e?this:o,f;return r.array&&(f=u.createCollection(),n[t]=f),new i.AssociatedEntitiesView(n,c,h,r.association,s,f)},_disposeAssociationEntitiesViews:function(n){var i=this._associatedEntitiesViews[n];i&&t.each(i,function(n,t){t.dispose()}),delete this._associatedEntitiesViews[n]},_getSerializableEntity:function(n){if(!this._dataContext.__manageAssociations)return n;var r={};return t.each(i.metadata.getProperties(n,this._entityType),function(t,i){r[i.name]=n[i.name]}),r}},o={__getIdentity:function(n,r){var s=i.metadata(r),f,o,e;if(!s)throw"No metadata available for type '"+r+"'.  Register metadata using 'upshot.metadata(...)'.";f=s.key;if(!f)throw"No key metadata specified for entity type '"+r+"'";return f.length==1&&f[0].indexOf(".")==-1?(o=f[0],i.EntitySet.__validateKeyMember(o,o,n,r),u.getProperty(n,o).toString()):(e="",t.each(f,function(f,o){e.length>0&&(e+=",");var h=o.split("."),s=n;t.each(h,function(n,t){i.EntitySet.__validateKeyMember(t,o,s,r),s=u.getProperty(s,t)}),e+=s}),e)},__validateKeyMember:function(n,t,i,r){if(!i||!(n in i))throw"Key member '"+t+"' doesn't exist on entity type '"+r+"'";}};i.EntitySet=i.deriveClass(f,h,s),t.extend(i.EntitySet,o)})(this,jQuery,upshot),(function(n,t,i,r){function f(n,i){var u,r;if(i){u=t.extend(u,i[n]||{});for(r in i)r!=="get"&&r!=="submit"&&(u[r]=i[r])}return u}var u=i.observability,o=function(n,t,u){if(this._trigger===r)return new i.DataContext(n,t);this._dataProvider=n,this.__manageAssociations=!0,this._implicitCommitHandler=t,this._eventCallbacks={},this._entitySets={},this._mappings={},u&&this.addMapping(u)},e={dispose:function(){this._entitySets&&(t.each(this._entitySets,function(n,t){t.__dispose()}),this._entitySets=null)},bind:function(n,t){var r,i;if(typeof n=="string")r=this._eventCallbacks[n]||(this._eventCallbacks[n]=[]),r.push(t);else for(i in n)this.bind(i,n[i]);return this},unbind:function(n,t){var r,i,f,u;if(typeof n=="string"){r=this._eventCallbacks[n];if(r)for(i=0,f=r.length;i<f;i++)if(r[i]===t){r.splice(i,1);break}}else for(u in n)this.unbind(u,n[u]);return this},addMapping:function(n,i){var u,r;return typeof n=="string"?(u=i,i={},i[n]=u):i=n,r=this,t.each(i,function(n,i){var u,f;t.isFunction(i)&&(i={map:i}),u=r._mappings[n];if(u){if(u.map!==i.map||u.unmap!==i.unmap)throw"For a given type, DataContext.addMapping must be supplied the same map/unmap functions.";}else{f=r._entitySets[n];if(f&&f.getEntities().length>0)throw"Supply a mapping for a type before loading data of that type";r._mappings[n]={map:i.map,unmap:i.unmap}}}),this},getEntitySet:function(n){var t=this._entitySets[n];return t||(t=this._entitySets[n]=new i.EntitySet(this,n)),t},getEntityErrors:function(){var n=[];return t.each(this._entitySets,function(t,i){var r=[n.length,0].concat(i.getEntityErrors());[].splice.apply(n,r)}),n},getEntityError:function(n){var i;return t.each(this._entitySets,function(t,r){return i=r.getEntityError(n),!i}),i},commitChanges:function(n,t,i){if(this._implicitCommitHandler)throw"Data context must be in change-tracking mode to explicitly commit changes.";return this._commitChanges(n,t,i),this},revertChanges:function(){return t.each(this._entitySets,function(n,t){t.__revertChanges()}),i.__triggerRecompute(),this},merge:function(n,r,f){var s=this,e,o;return f=f||{},t.each(n,function(n,t){u.setProperty(t,"__type",r),s.__flatten(t,r,f)}),t.each(f,function(n,i){t.each(i,function(t,i){u.setProperty(i,"__type",n)});var r=s.getEntitySet(n);r.__loadEntities(i)}),e=r&&this.getEntitySet(r),o=e?e.__loadEntities(n):[],i.__triggerRecompute(),o},__flatten:function(n,r,f){var e=this;t.each(i.metadata.getProperties(n,r,!0),function(r,o){var h=u.getProperty(n,o.name);if(h)if(o.association){var l=i.isArray(h)?h:[h],c=o.type,s=f[c]||(f[c]=[]);t.each(l,function(n,t){var r=i.EntitySet.__getIdentity(t,c);s.identityMap||(s.identityMap={}),s.identityMap[r]||(s.identityMap[r]=!0,s.push(t),e.__flatten(t,c,f))})}})},__load:function(n,r,u){var h=this._dataProvider,e=this,c=function(u){var f,h,o,s;u.metadata&&i.metadata(u.metadata),f=u.type||n.entityType;if(!f)throw"Unable to determine entity type.";h=t.map(u.entities,function(n){return e._mapEntity(n,f)}),u.includedEntities&&(o={},t.each(u.includedEntities,function(n,i){o[n]=t.map(i,function(t){return e._mapEntity(t,n)})})),s=e.merge(h,f,o),r.call(e,e.getEntitySet(f),s,u.totalCount)},o=function(n,t,i){u.call(e,n,t,i)},s=f("get",n.providerParameters);h.get(s,n.queryParameters,c,o)},__queueImplicitCommit:function(){if(this._implicitCommitHandler)if(!this._implicitCommitQueued){this._implicitCommitQueued=!0;var n=this;setTimeout(function(){n._implicitCommitQueued=!1,n._implicitCommitHandler()},0)}},_trigger:function(n){var t=this._eventCallbacks[n],u,i,r;if(t)for(u=Array.prototype.slice.call(arguments,1),t=t.slice(0),i=0,r=t.length;i<r;i++)t[i].apply(this,u);return this},_submitChanges:function(n,r,e,o){var h;this._trigger("commitStart"),h=t.map(r,function(n){return n.entitySet.__getEntityEdit(n.entity)}),t.each(h,function(n,t){t.updateEntityState()});var s=this,c=function(n,t,i){var r={Id:i.Id,Operation:i.Operation};return i.Operation!==4&&(r.Entity=s._mapEntity(i.Entity,t)),r},y=function(n,t,i){var f={Id:n.toString(),Operation:i.Operation,Entity:i.Entity,OriginalEntity:i.OriginalEntity},r;return i.Operation!==4&&(r=(s._mappings[t]||{}).unmap||u.unmap,f.Entity=r(i.Entity,t)),f},p=t.map(h,function(n,t){return y(t,n.entityType,n.operation)}),v=function(n){t.each(h,function(t,i){i.succeeded(c(i.storeEntity,i.entityType,n[t]))}),i.__triggerRecompute(),s._trigger("commitSuccess",n),e&&e.call(s,n)},l=function(n,r,u,f){t.each(h,function(n,t){if(f){var i=f[n];i.Error?t.failed(i.Error):t.succeeded(c(t.storeEntity,t.entityType,i))}else t.failed(null)}),i.__triggerRecompute(),s._trigger("commitError",n,r,u,f),o&&o.call(s,n,r,u,f)},a=f("submit",n.providerParameters);this._dataProvider.submit(a,p,v,l)},_commitChanges:function(n,r,u){var f=[];t.each(this._entitySets,function(n,i){var r=t.map(i.__getEditedEntities(),function(n){return{entitySet:i,entity:n}});[].push.apply(f,r)}),this._submitChanges(n,f,r,u),i.__triggerRecompute()},_mapEntity:function(n,t){return this._map(n,t,!0)},_map:function(n,t,r){var f,o,e;if(r||i.isObject(n)){f=(this._mappings[t]||{}).map;if(f)return new f(n)}return o=this,e=function(n,t){return o._map(n,t)},u.map(n,t,e)}};i.DataContext=i.defineClass(o,e)})(this,jQuery,upshot),(function(n,t,i){function e(n,t){var r,u;return t?(r=n.Results,u=n.TotalCount):r=n,{entities:i.isArray(r)?r:[r],totalCount:u}}var f={get:function(n,r,u,f){var c,o;n&&(c=n.operationName,o=n.operationParameters),t.isFunction(o)&&(u=o,f=r);var s=this,v=i.DataProvider.normalizeUrl(n.url)+c,h=i.ODataDataProvider.getODataQueryParameters(r),a=t.extend({},o,h),l=h.$inlinecount=="allpages";t.ajax({url:v,data:a,success:u&&function(){arguments[0]=e(arguments[0],l),u.apply(s,arguments)},error:f&&function(n,t,i){f.call(s,n.status,s._parseErrorText(n.responseText)||i,n)},dataType:"json"})},submit:function(n,r,u,f){t.each(r,function(n,t){switch(t.Operation){case 2:t.Operation=1;break;case 3:t.Operation=2;break;case 4:t.Operation=3}});var e=this,o=JSON.stringify(r);t.ajax({url:i.DataProvider.normalizeUrl(n.url)+"Submit",contentType:"application/json",data:o,dataType:"json",type:"POST",success:(u||f)&&function(n,i,r){var o=n,l=!1,c,s,h;o&&t.each(o,function(n,i){t.each(["ConflictMembers","ValidationErrors","IsDeleteConflict"],function(n,t){i.hasOwnProperty(t)&&(i.Error=i.Error||{},i.Error[t]=i[t],l=!0)})});if(l){if(f){c="Submit failed.";if(o)for(s=0;s<o.length;++s){h=o[s].ValidationErrors&&o[s].ValidationErrors[0]&&o[s].ValidationErrors[0].Message;if(h){c=h;break}}f.call(e,r.status,c,r,o)}}else u&&u.call(e,o)},error:f&&function(n,t,i){f.call(e,n.status,e._parseErrorText(n.responseText)||i,n)}})},_parseErrorText:function(n){var i=/Exception]: (.+)\r/g.exec(n),t;if(i&&i[1])return i[1];if(/^{.*}$/g.test(n)){t=JSON.parse(n);if(t.ErrorMessage)return t.ErrorMessage;if(t.Message)return t.Message}}},u={normalizeUrl:function(n){return n&&n.substring(n.length-1)!=="/"?n+"/":n}};i.DataProvider=i.defineClass(null,f,u)})(this,jQuery,upshot),(function(n,t,i,r){var u=i.DataSource.prototype,f=["commitStart","commitSuccess","commitError"],o=function(n){var s,h,e,a,o,v,c,l;if(this._trigger===r)return new i.RemoteDataSource(n);this._sort=null,this._filters=null;if(n){this._providerParameters=n.providerParameters,this._entityType=n.entityType,h=n.dataContext,s=n.provider||n.dataContext?n.provider:i.DataProvider,t.isFunction(s)&&(s=new s),e=n.mapping;if(e&&(t.isFunction(e)||t.isFunction(e.map)||t.isFunction(e.unmap))){if(!this._entityType)throw"Need 'entityType' option in order to supply "+(t.isFunction(e)?"a function":"map/unmap functions")+" for 'mapping' option.";a=e,e={},e[this._entityType]=a}}o=this,h?e&&h.addMapping(e):(n.bufferChanges||(v=function(){o._dataContext._commitChanges({providerParameters:o._providerParameters})}),h=new i.DataContext(s,v,e)),this._dataContext=h,c={},t.each(f,function(n,t){c[t]=function(){o._trigger.apply(o,[t].concat(Array.prototype.slice.call(arguments)))}}),this._dataContextObserver=c,this._dataContext.bind(this._dataContextObserver),l=n&&n.entityType&&this._dataContext.getEntitySet(n.entityType),l?n=t.extend({},n,{source:l}):(t.each(i.EntityView.__dataContextMethodNames,function(n,t){t!=="getDataContext"&&(o[t]=function(){throw'DataContext-specific methods are not available on RemoteDataSource a result type can be determined.  Consider supplying the "entityType" option when creating a RemoteDataSource or execute an initial query against your RemoteDatasource to determine the result type.';})}),this.getDataContext=function(){return this._dataContext}),u.constructor.call(this,n),this._bindFromOptions(n,f)},e={setSort:function(n){return this._sort=n&&!i.isArray(n)?[n]:n,this},setFilter:function(n){return this._filters=n&&this._normalizeFilters(n),this},refresh:function(n,i,u){this._verifyOkToRefresh(),t.isFunction(n)&&(u=i,i=n,n=r),this._trigger("refreshStart");var f=this,o=function(n,t,r){f._bindToEntitySource(n),f._completeRefresh(t,r,i)},e=function(n,t,i){f._failRefresh(n,t,i,u)};return this._dataContext.__load({entityType:this._entityType,providerParameters:this._providerParameters,queryParameters:{filters:this._filters,sort:this._sort,skip:this._skip,take:this._take,includeTotalCount:this._includeTotalCount}},o,e),this},commitChanges:function(n,i){return this._dataContext.commitChanges({providerParameters:this._providerParameters},t.proxy(n,this),t.proxy(i,this)),this},_dispose:function(){this._dataContext.unbind(this._dataContextObserver),u._dispose.apply(this,arguments)},_bindToEntitySource:function(n){u._bindToEntitySource.call(this,n),this.revertChanges=function(){return arguments.length>0?this._entitySource.revertChanges.apply(this._entitySource,arguments):this._dataContext.revertChanges()}}};i.RemoteDataSource=i.deriveClass(u,o,e)})(this,jQuery,upshot),(function(n,t,i,r){var f=i.EntityView.prototype,u=i.observability,o=function(n,i,r,u,e,o){var s,c,h;this._entity=n,this._parentEntitySet=i,this._childEntitySet=r,this._associationMetadata=u,this._parentPropertySetter=e,s=this,this._sourceEntitySetObserver=function(n,i){s._needRecompute||t.inArray(i,u.thisKey)<0||s._setNeedRecompute()},c=u.isForeignKey?r:i,c.bind("propertyChanged",this._sourceEntitySetObserver),h=u.isForeignKey?i:r,f.constructor.call(this,{source:h,result:o}),this._initialized=!1,this._setNeedRecompute()},e={__handleParentPropertySet:function(n){this._handleRelationshipEdit(this._entity,n)},_dispose:function(){var n=this._associationMetadata.isForeignKey?this._childEntitySet:this._parentEntitySet;n.unbind("propertyChanged",this._sourceEntitySetObserver),f._dispose.apply(this,arguments)},_handleEntityAdd:function(n){this._handleRelationshipEdit(n,this._entity)},_handleRelationshipEdit:function(n,i){var o=this._associationMetadata,l=o.isForeignKey,e,a,c,s,h,v;if(i){if(t.inArray(i,u.asArray(this._parentEntitySet.getEntities()))<0)throw"Parent entity is not in the parent entity set for this association.";else if((this._parentEntitySet.getEntityState(i)||"").indexOf("Add")>0)throw"NYI -- Cannot set foreign keys to key values computed from added entities.  Commit the parent entity first.";a=l?o.otherKey:o.thisKey,e=u.getProperty(i,a[0]);if(e===r)throw"Parent entity has no value for its '"+a[0]+"' key property.";}else e=null;c=l?o.thisKey:o.otherKey,s=u.getProperty(n,c[0]),i?(s===r||s!==e)&&(h=!0):s!==null&&(h=!0),v=!l,v&&t.inArray(n,u.asArray(this._entitySource.getEntities()))<0&&f._handleEntityAdd.call(this,n),h&&this._childEntitySet.__setProperty(n,c[0],e)},_onPropertyChanged:function(n,i){this._needRecompute||t.inArray(i,this._associationMetadata.otherKey)<0||this._setNeedRecompute(),f._onPropertyChanged.apply(this,arguments)},_onArrayChanged:function(n,i){var r,u;if(this._needRecompute)return;switch(n){case"insert":case"remove":u=this,t.each(i.items,function(t,i){if(u._haveEntity(i)^n==="insert")return r=!0,!1});break;case"replaceAll":r=!0;break;default:throw"NYI -- Array operation '"+n+"' is not supported.";}r&&this._setNeedRecompute()},_recompute:function(){var n=this._clientEntities,i=this._computeAssociatedEntities(),o,r,e,f;this._initialized?(r=this,e=t.grep(i,function(i){return t.inArray(i,u.asArray(n))<0}),t.each(e,function(t,i){var e=u.asArray(n).length,f=[i];u.insert(n,e,f),r._trigger("arrayChanged","insert",{index:e,items:f})}),f=t.grep(u.asArray(n),function(n){return t.inArray(n,i)<0}),t.each(f,function(i,f){var e=t.inArray(f,u.asArray(n));u.remove(n,e,1),r._trigger("arrayChanged","remove",{index:e,items:[f]})})):(this._initialized=!0,i.length>0&&(o=u.asArray(n).slice(),u.refresh(n,i),this._trigger("arrayChanged","replaceAll",{oldItems:o,newItems:u.asArray(n)}))),this._parentPropertySetter&&this._parentPropertySetter.apply(this)},_computeAssociatedEntities:function(){for(var h=this._entity,f=this._associationMetadata,s=u.getProperty(h,f.thisKey[0]),l=f.isForeignKey?this._parentEntitySet:this._childEntitySet,o=u.asArray(l.getEntities()),c=f.otherKey,e=[],t,i,n=0;n<o.length;n++)t=o[n],i=u.getProperty(t,c[0]),i!==r&&i===s&&e.push(t);return e}};i.AssociatedEntitiesView=i.deriveClass(f,o,e)})(this,jQuery,upshot),(function(n,t,i,r){var f=i.DataSource.prototype,u=i.observability,o=function(n){var t,e;if(this._trigger===r)return new i.LocalDataSource(n);t=n&&n.source;if(t&&!t.__recomputeDependentViews){e=u.isArray(t)&&i.EntitySource.as(t);if(!e)throw"Input data for a LocalDataSource must be an EntitySource or the array returned by EntitySource.getEntities().";n.source=e}this._autoRefresh=n&&n.autoRefresh,this._sort=null,this._filter=null,this._refreshAllInProgress=!1,f.constructor.call(this,n),this._bindFromOptions(n,["refreshNeeded"]),this._autoRefresh&&this.refresh()},e={setSort:function(n){return this._sort=n,this},setFilter:function(n){this._filter=n&&this._createFilterFunction(n)},refresh:function(n,i,f){function o(n){e._needRecompute=!1;var t=e._applyQuery(n);e._completeRefresh(t.entities,t.totalCount,i)}this._verifyOkToRefresh(),t.isFunction(n)&&(f=i,i=n,n=r),this._trigger("refreshStart");var e=this,s=this._entitySource.refresh;return n&&!!n.all&&s?(this._refreshAllInProgress=!0,this._entitySource.refresh({all:!0},function(n){o(n),e._refreshAllInProgress=!1},function(n,t,i){e._failRefresh(n,t,i,f)})):setTimeout(function(){o(u.asArray(e._entitySource.getEntities()))}),this},refreshNeeded:function(){return this._needRecompute},_setNeedRecompute:function(){this._autoRefresh?f._setNeedRecompute.call(this):(this._needRecompute=!0,this._trigger("refreshNeeded"))},_recompute:function(){this._trigger("refreshStart");var n=this._applyQuery(u.asArray(this._entitySource.getEntities()));this._applyNewQueryResult(n.entities,n.totalCount),this._trigger("refreshSuccess",u.asArray(this._clientEntities),this._lastRefreshTotalEntityCount)},_normalizePropertyValue:function(n,t){return u.getProperty(n,t)||""},_onPropertyChanged:function(n,r){f._onPropertyChanged.apply(this,arguments);if(this._refreshAllInProgress)return;if(!this._needRecompute){var e=!1;this._haveEntity(n)?this._filter&&!this._filter(n)&&(e=!0):this._filter&&this._filter(n)&&(e=!0),this._haveEntity(n)&&this._sort&&(e=t.isFunction(this._sort)?!0:i.isArray(this._sort)?t.grep(this._sort,function(n){return n.property===r}).length>0:this._sort.property===r),e&&this._setNeedRecompute()}},_createFilterFunction:function(n){function o(n,t,i){var r;switch(t){case"<":r=function(n){return n<i};break;case"<=":r=function(n){return n<=i};break;case"==":r=function(n){return n==i};break;case"!=":r=function(n){return n!=i};break;case">=":r=function(n){return n>=i};break;case">":r=function(n){return n>i};break;case"Contains":r=function(n){return typeof n=="string"&&typeof i=="string"&&(n=n.toLowerCase(),i=i.toLowerCase()),n.indexOf(i)>=0};break;default:throw"Unrecognized filter operator.";}return function(t){var i=s._normalizePropertyValue(t,n);return r(i)}}var s=this,f,r,u,i,e;if(t.isFunction(n))return n;for(f=this._normalizeFilters(n),r=[],u=0;u<f.length;u++)i=f[u],t.isFunction(i)?r.push(i):(e=o(i.property,i.operator,i.value),r.push(e));return function(n){for(var t=0;t<r.length;t++)if(!r[t](n))return!1;return!0}},_getSortFunction:function(){function r(n){return function(t,i){var e=!n.descending,o=n.property,r=u._normalizePropertyValue(t,o),f=u._normalizePropertyValue(i,o);return r==f?0:r>f?e?1:-1:e?-1:1}}var u=this,n;return this._sort?t.isFunction(this._sort)?this._sort:i.isArray(this._sort)?(t.each(this._sort,function(t,i){var u=r(i);n=n?function(n,t){return function(i,r){var u=n(i,r);return u===0?t(i,r):u}}(n,u):u}),n):r(this._sort):null},_applyQuery:function(n){var o=this,i,f,r,e,u;return i=this._filter?t.grep(n,function(n){return o._filter(n)}):n,f=this._getSortFunction(),f?(i===n&&(i=i.slice(0)),r=i.sort(f)):r=i,e=this._skip||0,u=e>0?r.slice(e):r,this._take&&(u=u.slice(0,this._take)),{entities:u,totalCount:r.length}},_onArrayChanged:function(n,r){var o,e,h,c,l,s;f._onArrayChanged.apply(this,arguments);if(this._refreshAllInProgress)return;if(!this._needRecompute){o=this,e=!1;switch(n){case"insert":h=r.items,h.length>0&&(c=t.grep(h,function(n){return(!o._filter||o._filter(n))&&t.inArray(n,u.asArray(o._clientEntities))<0}).length>0,c&&(e=!0));break;case"remove":this._take>0||this._skip>0?e=!0:(l=t.grep(r.items,function(n){return o._haveEntity(n)&&(o.getEntityState(n)||i.EntityState.Deleted)!==i.EntityState.Deleted}),l.length>0&&(e=!0));break;case"replaceAll":this._refreshAllInProgress||(s=this._applyQuery(r.newItems),e=this.totalCount!==s.totalCount?!0:!i.sameArrayContents(u.asArray(this._clientEntities),s.entities));break;default:throw"Unknown array operation '"+n+"'.";}e&&this._setNeedRecompute()}},_handleEntityAdd:function(n){this._needRecompute||this._filter&&!this._filter(n)&&this._setNeedRecompute(),f._handleEntityAdd.apply(this,arguments)},_handleEntityDelete:function(){!this._needRecompute&&this._take>0&&this._setNeedRecompute(),f._handleEntityDelete.apply(this,arguments)}};i.LocalDataSource=i.deriveClass(f,o,e)})(this,jQuery,upshot),(function(n,t,i,r){function u(n,t){var i="0000"+t;return i.slice(i.length-n)}function o(n){return"datetime'"+u(4,n.getUTCFullYear())+"-"+u(2,n.getUTCMonth()+1)+"-"+u(2,n.getUTCDate())+"T"+u(2,n.getUTCHours())+":"+u(2,n.getUTCMinutes())+":"+u(2,n.getUTCSeconds())+"'"}function s(n){var u=n.results,f=u.length&&u[0].__metadata.type,t,i,e;return f&&(t={},t[f]={key:["__metadata.uri"]}),i=n.__count,e=i===r?null:+i,{type:f,metadata:t,entities:u,totalCount:e}}var f={get:function(n,r,u,f){var l,o,h,e,c;n&&(l=n.operationName,o=n.operationParameters),t.isFunction(o)&&(u=o,f=r),h=this,e=[],t.each(t.extend({},o,i.ODataDataProvider.getODataQueryParameters(r)),function(n,t){e.push(n.toString()+"="+t.toString())}),c=e.length?"?"+e.join("&"):"",OData.read(i.DataProvider.normalizeUrl(n.url)+l+c,function(){u&&(arguments[0]=s(arguments[0]),u.apply(h,arguments))},function(n){f&&f.call(h,-1,n.message,n)})},submit:function(){throw"Saving edits through the OData data provider is not supported.";}},e={getODataQueryParameters:function(n){var r,u,e,f;return n=n||{},r={},n.filters&&n.filters.length&&(u="",e=function(n,t,r){typeof r=="string"?r=i.isGuid(r)?"guid'"+r+"'":"'"+r+"'":i.isDate(r)&&(r=o(r));switch(t){case"<":return n+" lt "+r;case"<=":return n+" le "+r;case"==":return n+" eq "+r;case"!=":return n+" ne "+r;case">=":return n+" ge "+r;case">":return n+" gt "+r;case"StartsWith":return"startswith("+n+","+r+") eq true";case"EndsWith":return"endswith("+n+","+r+") eq true";case"Contains":return"substringof("+r+","+n+") eq true";default:throw"The operator '"+t+"' is not supported.";}},t.each(n.filters,function(n,t){u&&(u+=" and "),u+=e(t.property,t.operator,t.value)}),r.$filter=u),n.sort&&n.sort.length&&(f=function(n){return!n.descending?n.property:n.property+" desc"},r.$orderby=t.map(n.sort,function(n){return f(n)}).join()),n.skip&&(r.$skip=n.skip),n.take&&(r.$top=n.take),n.includeTotalCount&&(r.$inlinecount="allpages"),r}};i.ODataDataProvider=i.defineClass(null,f,e)})(this,jQuery,upshot),(function(n,t,i){function e(n){var r={},u,e,f;return n.filters&&n.filters.length&&(u="",e=function(n,t,r){typeof r=="string"?r=i.isGuid(r)?"Guid("+r+")":'"'+r+'"':i.isDate(r)&&(r="DateTime("+(r.getTime()*1e4+621355968000000000)+")");switch(t){case"<":case"<=":case"==":case"!=":case">=":case">":return n+t+r;case"StartsWith":case"EndsWith":case"Contains":return n+"."+t+"("+r+")";default:throw"The operator '"+t+"' is not supported.";}},t.each(n.filters,function(n,t){u&&(u+=" AND "),u+=e(t.property,t.operator,t.value)}),r.$where=u),n.sort&&n.sort.length&&(f=function(n){return!n.descending?n.property:n.property+" desc"},r.$orderby=t.map(n.sort,function(n){return f(n)}).join()),n.skip&&(r.$skip=n.skip),n.take&&(r.$take=n.take),n.includeTotalCount&&(r.$includeTotalCount=n.includeTotalCount),r}function o(n){return n&&t.each(n||{},function(i,r){t.isArray(r)&&(n[i]=JSON.stringify(r))}),n}function u(n){var f,i,u,r;return t.each(n,function(n){if(/Result$/.test(n))return f=n,!1}),i=n[f],u={},t.each(i.Metadata,function(n,t){u[t.type]={key:t.key,fields:t.fields,rules:t.rules,messages:t.messages}}),i.IncludedResults&&(r={},t.each(i.IncludedResults,function(n,t){var i=t.__type,u=r[i]||(r[i]=[]);u.push(t)})),{type:i.Metadata[0].type,metadata:u,entities:i.RootResults,includedEntities:r,totalCount:i.TotalCount||0}}var f={get:function(n,r,f,s){var l,c,h;n&&(l=n.operationName,c=n.operationParameters),t.isFunction(c)&&(f=c,s=r),h=this,t.ajax({url:i.DataProvider.normalizeUrl(n.url)+"json/"+l,data:t.extend({},o(c),e(r||{})),success:f&&function(){arguments[0]=u(arguments[0]),f.apply(h,arguments)},error:s&&function(n,t,i){s.call(h,n.status,h._parseErrorText(n.responseText)||i,n)},dataType:"json"})},submit:function(n,r,u,f){var e=this,o=JSON.stringify({changeSet:r});t.ajax({url:i.DataProvider.normalizeUrl(n.url)+"json/SubmitChanges",contentType:"application/json",data:o,dataType:"json",type:"POST",success:(u||f)&&function(n,i,r){var o=n.SubmitChangesResult,l=!1,c,s,h;o&&t.each(o,function(n,i){t.each(["ConflictMembers","ValidationErrors","IsDeleteConflict"],function(n,t){i.hasOwnProperty(t)&&(i.Error=i.Error||{},i.Error[t]=i[t],l=!0)})});if(l){if(f){c="Submit failed.";if(o)for(s=0;s<o.length;++s){h=o[s].ValidationErrors&&o[s].ValidationErrors[0]&&o[s].ValidationErrors[0].Message;if(h){c=h;break}}f.call(e,r.status,c,r,o)}}else u&&u.call(e,o)},error:f&&function(n,t,i){f.call(e,n.status,e._parseErrorText(n.responseText)||i,n)}})},_parseErrorText:function(n){var i=/Exception]: (.+)\r/g.exec(n),t;if(i&&i[1])return i[1];if(/^{.*}$/g.test(n)){t=JSON.parse(n);if(t.ErrorMessage)return t.ErrorMessage}}};i.riaDataProvider=i.defineClass(null,f)})(this,jQuery,upshot);